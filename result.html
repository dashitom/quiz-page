<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>リザルト</title>
<style>
body {
  margin: 0;
  height: 100dvh;
  font-family: 'Arial', sans-serif;
  color: #000;
  position: relative;
  overflow: hidden;
  background-color: #fff;
}

/* 背景格子 */
body::before {
  content: "";
  position: fixed;
  top:0; left:0;
  width:100%; height:100%;
  background-image: linear-gradient(to right, rgba(0,0,0,0.05) 1px, transparent 1px),
                    linear-gradient(to bottom, rgba(0,0,0,0.05) 1px, transparent 1px);
  background-size: 30px 30px;
  pointer-events: none;
}

.container {
  position: relative;
  width: 80%;
  margin: 5dvh auto;
  z-index: 1;
}

.line1 {
  font-size: 2em;
  font-weight: bold;
  text-align: left;
  opacity: 0;
}
.strike.exec { color:#eee;/*text-decoration: line-through; text-decoration-thickness: 5px;*/ }

.line2 {
  font-size: 6em;
  font-weight: bold;
  text-align: left;
  margin-top:-3dvh;
  opacity: 0;
}
.line3 {
  font-size: 2em;
  font-weight: bold;
  text-align: left;
  color: #c00;
  opacity: 0;
}
.line4 {
  font-size: 1em;
  font-weight: bold;
  text-align: left;
  margin-top: 5dvh;
  opacity: 0;
}
.line5 {
  font-size: 1em;
  font-weight: bold;
  text-align: left;
  margin-top: 5dvh;
  opacity: 0;
}

/* 画像ボックス */
.face-container {
  width: 150px;
  height: 150px;
  position: absolute;
  top: 10dvh;
  right: -5vw;
  perspective: 800px;
}
.float-wrap {
  animation: float 2s ease-in-out infinite;
}
.face {
  width: 30vw;
  height: 30vw;
  object-fit: contain;
  opacity: 1;
  display:block;
  margin:0 auto;
  transition: transform 0.5s ease, opacity 0.5s ease;
}

/* アニメーション */
@keyframes float {
  0%,100% { transform: translateY(0); }
  50% { transform: translateY(-20px); }
}
@keyframes showLine {
  to { opacity: 1; }
}

.score{font-size:2.5em;font-weight:bold;margin-bottom:0.6em;}
.note{font-size:0.95em;margin-bottom:1em;}
.staff{margin-top:0.5em;}
.member{margin-bottom:0.8em;}
.role{font-size:0.85em;margin-bottom:0.25em;}
.row{display:flex;align-items:center;gap:0.6em;}
.icon{width:5dvh;height:5dvh;border-radius:50%;object-fit:cover;}
.name{padding-left:0.5em;font-weight:bold;font-size:1.3em;}

/*初期表示*/
#first-tap-area{
  position:fixed;
  inset:0;
  display:flex;
  justify-content:center;
  align-items:center;
  background:#fff;
  z-index:3000;
}
#first-tap-area span{
  width:15dvh;
  height:15dvh;
  display:flex;
  justify-content:center;
  align-items:center;
  border:5px solid #aaa;
  font-weight: bold;
  color:#aaa;
  border-radius:50%;
  font-size:2em;
  animation: heartbeat 1.6s ease-in-out infinite;
}
#first-tap-area.hide span{
  animation: tapFade 0.2s forwards;
}
#first-tap-area.hide{
  animation: bgFade 0.3s forwards;
}

@keyframes heartbeat {
  0%   { transform: scale(1); }
  10%  { transform: scale(1.08); } /* 1回目の鼓動 */
  20%  { transform: scale(1); }
  30%  { transform: scale(1.12); } /* 2回目の鼓動（少し強め） */
  40%  { transform: scale(1); }
  100% { transform: scale(1); }
}

@keyframes tapFade {
  0%   { transform: scale(1); opacity:1;}
  100%  { transform: scale(0.3); opacity:0;}
}
@keyframes bgFade {
  0%   { transform: scale(1); opacity:1;}
  100%  { transform: scale(1); opacity:0;}
}
</style>
</head>
<body>
<div class="container">

  <div id="first-tap-area" onclick="tap();">
    <span>Tap!</span>
  </div>

  <div class="line1">あなたの<span class="strike">脳</span>年齢は</div>
  <div class="line2">60才</div>
  <div class="line3 flash">還暦おめでとう！</div>
  <div class="face-container">
    <div class="float-wrap">
      <img src="kawashima.png" class="face" id="face" >
    </div>
  </div>
  <div class="line4">
    <div class="score">スコア <Span id="score-value">12345</span></div>
    <br>
  </div>
  <div class="line5">
    <div class="staff">
      <div class="member">
        <div class="role">ゲームディレクター：</div>
        <div class="row">
          <img src="icon1.png" class="icon" alt="">
          <div class="name">吉田　達彦</div>
        </div>
      </div>

      <div class="member">
        <div class="role">Web開発：</div>
        <div class="row">
          <img src="icon2.png" class="icon" alt="">
          <div class="name">吉田　朋弘</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>

const imageUrls = ["kawashima.png", "kawashima2.png", "pico.png"];
const face = document.getElementById('face');
const strike = document.querySelector('.strike');
const line1 = document.querySelector('.line1');
const line2 = document.querySelector('.line2');
const line3 = document.querySelector('.line3');
const line4 = document.querySelector('.line4');
const line5 = document.querySelector('.line5');

// すべての画像がロード完了してからアニメーション開始
Promise.all(imageUrls.map(src => new Promise(resolve => {
  const img = new Image();
  img.onload = resolve;
  img.onerror = resolve; // 失敗しても進む
  img.src = src;
}))).then(() => {
});

var executed = false;

function tap(){
  if(executed) retuen;
  executed = true;

  bgm_mario = prePlaySound('mario');
  se_clap = prePlaySound('clap');
  se_clap.currentTime = 0.5;

  document.getElementById('first-tap-area').classList.add('hide');
  playSound(se_clap);

  setTimeout(() => {
    line1.style.animation = "showLine 0.01s forwards";
    playSound(se_clap);
  }, 1100);

  // ① 3秒後：上昇開始
  setTimeout(() => {
    stopFloat();
    
    var firstSE = true; 
    bgm_mario.volume = 1.0;
    bgm_mario.currentTime = 7.0;
    bgm_mario.play();
    /*
    //いったんストップ
    bgm_mario.addEventListener("timeupdate", () => {
      if (bgm_mario.currentTime >= 8.45 && firstSE) {
        firstSE = false;
        bgm_mario.pause();
      }
    });*/

    face.src = "kawashima2.png";
    // 画像が読み込まれたら上昇を開始
    face.onload = () => {
      face.style.transition = "transform 0.8s ease-in";
      face.style.opacity = "1";
      face.style.transform = "translateY(-40dvh)";
    };
    
  }, 3000);

  // ② 画像差し替え → 下に落ちる
  setTimeout(() => {
    face.src = "pico.png";
    face.onload = () => {
      face.style.transition = "transform 0.2s ease-out";
      face.style.transform = "translateY(0)";
    }
  }, 4500);

  // ③ 60才を表示
  setTimeout(() => {
    line2.style.animation = "showLine 0.01s forwards";
    strike.classList.add("exec");
    //BGM再開
//    bgm_mario.currentTime = 8.55;
//    bgm_mario.play();

    //還暦おめでとう
    line3.style.animation = "showLine 0.5s forwards";

    //紙吹雪
    startConfetti(); 

    //ふわふわ再開
    startFloat();
    face.style.animation = "showLine 0s forwards, float 0.5s ease-in-out infinite";
    
    //スコア
    setTimeout(() => {
      line4.style.animation = "showLine 0.5s forwards";
      const hash = window.location.hash;
      const scoreValue = hash.replace('#score=', '');
      addScore(scoreValue, 5.2);
      //document.getElementById('score-value').textContent = scoreValue;
    }, 1000);

    //開発者
    setTimeout(() => {
      line5.style.animation = "showLine 0.5s forwards";
    }, 2000);

  }, 5000);

}


// ふわふわ停止
function stopFloat() {
  face.style.animationPlayState = "paused";
}

// ふわふわ再開
function startFloat() {
  face.style.animation = "float 2s ease-in-out infinite";
}

let score = 0;
let displayScore = 0;
const scoreEl = document.getElementById('score-value');

function addScore(amount, durationSec = 1.0) {
  const startValue = displayScore;
  score = Math.max(0, score + amount);
  const target = score;

  const startTime = performance.now();
  const duration = durationSec * 1000;

  const animate = (now) => {
    const t = Math.min(1, (now - startTime) / duration);
    const current = Math.round(startValue + (target - startValue) * t);

    displayScore = current;

    scoreEl.textContent =
      target <= 99999
        ? current.toString().padStart(5, '0')
        : current.toString();

    if (t < 1) requestAnimationFrame(animate);
    else {
      displayScore = target;
      scoreEl.textContent =
        target <= 99999
          ? target.toString().padStart(5, '0')
          : target.toString();
    }
  };

  requestAnimationFrame(animate);
}

//紙吹雪
function createConfettiPiece() {
  const confetti = document.createElement('div');
  const size = Math.random() * 8 + 4; // 大きさ4〜12px
  confetti.style.position = 'fixed';
  confetti.style.top = '-10px';
  confetti.style.left = Math.random() * 100 + 'vw';
  confetti.style.width = size + 'px';
  confetti.style.height = size * 0.4 + 'px';
  confetti.style.backgroundColor = `hsl(${Math.random() * 360}, 80%, 60%)`;
  confetti.style.opacity = Math.random() * 0.8 + 0.2;
  confetti.style.borderRadius = '2px';
  confetti.style.zIndex = 9999;
  confetti.style.pointerEvents = 'none';

  // 初期回転
  const rotation = Math.random() * 360;
  confetti.style.transform = `rotate(${rotation}deg)`;
  document.body.appendChild(confetti);

  // 落下アニメーション
  const fallDuration = Math.random() * 3 + 4; // 4〜7秒で落下
  const horizontalShift = Math.random() * 40 - 20; // 左右の揺れ

  confetti.animate([
    { transform: `translate(0, 0) rotate(${rotation}deg)` },
    { transform: `translate(${horizontalShift}vw, 100dvh) rotate(${rotation + 360}deg)` }
  ], {
    duration: fallDuration * 1000,
    easing: 'linear',
    fill: 'forwards'
  });

  // 終了後に削除
  setTimeout(() => confetti.remove(), fallDuration * 1000);
}

function startConfetti() {
  setInterval(() => {
    for (let i = 0; i < 5; i++) createConfettiPiece();
  }, 200); // 常時発生（0.2秒ごと）
}

// ==== 音声処理 ====

var bgm_mario;
var se_clap;

const soundCache = {};

function preloadSounds(list){

  list.forEach(name=>{
    const a = new Audio('bgm/' + name + '.mp3');
    a.preload = 'auto';
    soundCache[name] = a;
  });
}

function prePlaySound(name){

  audio = new Audio('bgm/' + name + '.mp3');
  audio.preload = 'auto';

  audio.volume = 0.0;
  audio.play();
  audio.pause();
  return audio;
}

function playSound(target){
  target.volume = 1.0;
  /*
  target.play().then(()=>{
    // 再生が終わったら自動でリセットして pause
    target.addEventListener('ended', () => {
      target.currentTime = 0;
      target.pause();
    }, { once: true });
  }).catch(()=>{});
  */
  target.addEventListener("timeupdate", () => {
    if (target.currentTime >= 1.0) {
      target.currentTime = 0;
      target.pause();
    }
  });
  target.play();
}


</script>
</body>
</html>
