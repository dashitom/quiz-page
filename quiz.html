<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<link rel="stylesheet" href="style.css">
<title>AI脳トレ</title>
<script>
// --- 問題データ ---
const quizData=[
  {"stage":"1","quiztype":"計算力","question":"１＋１＝？","image":"","image2":"","image2time":"","options":[{"text":"1"},{"text":"2"}],"correct":"2","answertime":"10000","answerstart":"10000","perfect":"9500","excellent":"7500","great":"5000","good":"2500"},
  {"stage":"1","quiztype":"色彩認識力","question":"ピクセル数が多いのは？","image":"images/slime2.png","image2":"","image2time":"","options":[{"text":"黒"},{"text":"青"}],"correct":"青","answertime":"10000","answerstart":"10000","perfect":"9500","excellent":"7500","great":"5000","good":"2500"},
  {"stage":"1","quiztype":"パターン認識力","question":"？にあてはまるのは","image":"images/num1.png","image2":"","image2time":"","options":[{"text":"2"},{"text":"3"}],"correct":"2","answertime":"10000","answerstart":"10000","perfect":"9500","excellent":"7500","great":"5000","good":"2500"},
  {"stage":"1","quiztype":"注意力","question":"文字数が多いのは？","image":"images/ty.png","image2":"","image2time":"","options":[{"text":"T"},{"text":"Y"}],"correct":"Y","answertime":"10000","answerstart":"10000","perfect":"9500","excellent":"7500","great":"5000","good":"2500"},
  {"stage":"1","quiztype":"注意力","question":"じゃんけんで勝ってください<br>「グー」","image":"","image2":"","image2time":"","options":[{"text":"グー"},{"text":"チョキ"},{"text":"パー"}],"correct":"パー","answertime":"10000","answerstart":"10000","perfect":"9500","excellent":"7500","great":"5000","good":"2500"},
  {"stage":"2","quiztype":"計算力","question":"３５－３０＝？","image":"","image2":"","image2time":"","options":[{"text":"5"},{"text":"6"}],"correct":"5","answertime":"10000","answerstart":"10000","perfect":"9500","excellent":"7500","great":"5000","good":"2500"},
  {"stage":"2","quiztype":"色彩認識力","question":"ピクセル数が多いのは？","image":"images/slime3.png","image2":"","image2time":"","options":[{"text":"黒"},{"text":"青"}],"correct":"青","answertime":"10000","answerstart":"10000","perfect":"9500","excellent":"7500","great":"5000","good":"2500"},
  {"stage":"2","quiztype":"空間認識力","question":"進行方向は？","image":"images/bus_left.png","image2":"","image2time":"","options":[{"text":"左"},{"text":"右"}],"correct":"左","answertime":"10000","answerstart":"10000","perfect":"9500","excellent":"7500","great":"5000","good":"2500"},
  {"stage":"2","quiztype":"形状判断力","question":"若いのは？","image":"images/otama.png","image2":"","image2time":"","options":[{"text":"A"},{"text":"B"}],"correct":"A","answertime":"10000","answerstart":"10000","perfect":"9500","excellent":"7500","great":"5000","good":"2500"},
  {"stage":"2","quiztype":"注意力","question":"じゃんけんで負けてください","image":"images/tyoki1.png","image2":"","image2time":"","options":[{"text":"グー"},{"text":"パー"}],"correct":"パー","answertime":"10000","answerstart":"10000","perfect":"9500","excellent":"7500","great":"5000","good":"2500"},
  {"stage":"2","quiztype":"空間認識力","question":"進行方向は？","image":"images/bus_right.png","image2":"","image2time":"","options":[{"text":"左"},{"text":"右"}],"correct":"右","answertime":"10000","answerstart":"10000","perfect":"9500","excellent":"7500","great":"5000","good":"2500"},
  {"stage":"2","quiztype":"問題解決力","question":"片方しか助けられない。<br>どっちを助ける？","image":"","image2":"","image2time":"","options":[{"text":"母親"},{"text":"恋人"}],"correct":null,"answertime":"10000","answerstart":"10000","perfect":"9500","excellent":"7500","great":"5000","good":"2500"},
  {"stage":"3","quiztype":"記憶力","question":"今何問目？","image":"","image2":"","image2time":"","options":[{"text":"13"},{"text":"12"}],"correct":"13","answertime":"10000","answerstart":"10000","perfect":"9500","excellent":"7500","great":"5000","good":"2500"},
  {"stage":"3","quiztype":"パターン認識力","question":"？にあてはまるのは","image":"images/num2.png","image2":"","image2time":"","options":[{"text":"1"},{"text":"2"}],"correct":"1","answertime":"10000","answerstart":"10000","perfect":"9500","excellent":"7500","great":"5000","good":"2500"},
  {"stage":"3","quiztype":"形状判断力","question":"若いのは？","image":"images/keropen.png","image2":"","image2time":"","options":[{"text":"A"},{"text":"B"}],"correct":"B","answertime":"10000","answerstart":"10000","perfect":"9500","excellent":"7500","great":"5000","good":"2500"},
  {"stage":"3","quiztype":"注意力","question":"文字数が多いのは？","image":"images/moji2.png","image2":"","image2time":"","options":[{"text":"S"},{"text":"A"}],"correct":"S","answertime":"10000","answerstart":"10000","perfect":"9500","excellent":"7500","great":"5000","good":"2500"},
  {"stage":"3","quiztype":"判断力","question":"長男は？","image":"images/mario.png","image2":"","image2time":"","options":[{"text":"左"},{"text":"右"}],"correct":"左","answertime":"10000","answerstart":"10000","perfect":"9500","excellent":"7500","great":"5000","good":"2500"},
  {"stage":"3","quiztype":"色彩認識力","question":"ピクセル数が多いのは？","image":"images/slime.png","image2":"","image2time":"","options":[{"text":"黒"},{"text":"青"}],"correct":"青","answertime":"10000","answerstart":"10000","perfect":"9500","excellent":"7500","great":"5000","good":"2500"},
  {"stage":"4","quiztype":"空間認識力","question":"進行方向は？","image":"images/ookubo.png","image2":"","image2time":"","options":[{"text":"手前"},{"text":"奥"}],"correct":"手前","answertime":"10000","answerstart":"10000","perfect":"9500","excellent":"7500","great":"5000","good":"2500"},
  {"stage":"4","quiztype":"ドキドキ☆2択クイズ","question":"片方しか助けられない。<br>どっちを助ける？","image":"","image2":"images/tinmoku.png","image2time":"5000","options":[{"text":"娘"},{"text":"息子"}],"correct":null,"answertime":"10000","answerstart":"1","perfect":"","excellent":"-1000","great":"","good":"-2000"},
  {"stage":"4","quiztype":"注意力","question":"じゃんけんで負けてください","image":"images/tyoki2.png","image2":"","image2time":"","options":[{"text":"グー"},{"text":"パー"}],"correct":"パー","answertime":"10000","answerstart":"10000","perfect":"9500","excellent":"7500","great":"5000","good":"2500"},
  {"stage":"4","quiztype":"確認","question":"あなたは30才以上ですか？","image":"","image2":"","image2time":"","options":[{"text":"はい"},{"text":"いいえ"}],"correct":"はい","answertime":"10000","answerstart":"10000","perfect":"9500","excellent":"7500","great":"5000","good":"2500"},
  {"stage":"4","quiztype":"最終確認","question":"あなたは吉田達彦ですね？","image":"","image2":"","image2time":"","options":[{"text":"はい"}],"correct":"はい","answertime":"10000","answerstart":"10000","perfect":"9500","excellent":"7500","great":"5000","good":"2500"},
];

// --- ステージ情報 ---
const stageData=[
  {"stage":"1", "count":"5", "loadMsg":"問題を作成しています…", "startMsg":"まずは肩慣らしです。"},
  {"stage":"2", "count":"7", "loadMsg":"あなたの回答を分析しています…", "startMsg":"少しレベルを上げます！"},
  {"stage":"3", "count":"6", "loadMsg":"あなたにあわせて調整しています…", "startMsg":"やりますね！さらにレベルアップ！"},
  {"stage":"4", "count":"5", "loadMsg":"完全にあなたを理解しました…", "startMsg":"レベルMAX！最終ステージです！"},
]
</script>
</head>
<body>
<div class="cutin">
<div class="cutin-content">
<svg id="rankSvg" >
  <defs>
    <!-- 各グラデーション定義 -->
  <linearGradient id="pinkgold" x1="0%" y1="0%" x2="0%" y2="100%">
    <stop offset="0%" stop-color="#ffe6f2"/>
    <stop offset="25%" stop-color="#ffb3d9"/>
    <stop offset="50%" stop-color="#ff99cc"/>
    <stop offset="75%" stop-color="#ff66b3"/>
    <stop offset="100%" stop-color="#ffd6e6"/>
  </linearGradient>
  
    <linearGradient id="rainbow" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" stop-color="#ff8080"/>
      <stop offset="16%" stop-color="#ffc080"/>
      <stop offset="33%" stop-color="#ffff80"/>
      <stop offset="50%" stop-color="#80ff80"/>
      <stop offset="66%" stop-color="#80ffff"/>
      <stop offset="83%" stop-color="#8080ff"/>
      <stop offset="100%" stop-color="#ff80ff"/>
    </linearGradient>

    <linearGradient id="gold" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" stop-color="#fff2a8"/>
      <stop offset="30%" stop-color="#ffd700"/>
      <stop offset="60%" stop-color="#caa400"/>
      <stop offset="100%" stop-color="#fff4b3"/>
    </linearGradient>

    <linearGradient id="silver" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" stop-color="#ffffff"/>
      <stop offset="30%" stop-color="#d9d9d9"/>
      <stop offset="60%" stop-color="#b0b0b0"/>
      <stop offset="100%" stop-color="#e6e6e6"/>
    </linearGradient>

    <linearGradient id="bronze" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" stop-color="#ffe0b3"/>
      <stop offset="30%" stop-color="#cd7f32"/>
      <stop offset="60%" stop-color="#8b4513"/>
      <stop offset="100%" stop-color="#ffcc99"/>
    </linearGradient>
    
  <linearGradient id="blue" x1="0%" y1="0%" x2="0%" y2="100%">
    <stop offset="0%" stop-color="#e0f7ff"/>
    <stop offset="30%" stop-color="#66ccff"/>
    <stop offset="60%" stop-color="#3399ff"/>
    <stop offset="100%" stop-color="#0066cc"/>
  </linearGradient>
  </defs>

  <!-- メイン文字 -->
  <text id="rankText" x="50%" y="50%" text-anchor="middle" dominant-baseline="middle"
        fill="url(#rainbow)" stroke="#333" stroke-width="10" stroke-linejoin="round">
    EXCELLENT!
  </text>
  <!-- 光沢ハイライト -->
  <text id="rankTextHighlight" x="50%" y="50%" text-anchor="middle" dominant-baseline="middle"
        fill="url(#rainbow)" stroke="rgba(255,255,255,0.3)" stroke-width="1">
    EXCELLENT!
  </text>
</svg>
<div class="cutin-score">SCORE&nbsp;<span id="cutinScoreValue">9999</span></div>
</div>
</div>


<div id="stage-overlay" >
  <div id="stage-overlay-title" >
    <div id="stage-title" >STAGE 1</div>
    <div id="stage-msg" ></div>
    <div class="count-number" id="countNum" >3</div>
  </div>
  <div id="stage-overlay-loading" >
    <div id="loading-msg" ></div>
    <div class="loading-bar" id="loadingBar" ><div class="loading-progress" id="stageProgress"></div></div>
  </div>
</div>


<div class="container" >
  <!-- === ステージ情報バー === -->
  <div class="stage-info">
    <div class="stage-left" id="stage-info-title">STAGE 1</div>
    <div class="stage-center">
      <div class="stage-progress"></div>
    </div>
    <div class="stage-right">
      <span class="score-label">SCORE</span>
      <span class="score-value">0000</span>
    </div>
  </div>
  <div class="quiz-header" id="quiz-header" style="display:none;">
    <span id="quiz-no"></span>
  </div>
  <div class="question-box" id="question" style="display:none;"></div>
  <div class="timer-container" id="timer-container" style="display:none;">
    <div class="timer-label">TIME</div>
    <div class="timer-bar"><div class="timer-progress" id="timerProgress"></div></div>
  </div>
  <div class="buttons" id="buttons" style="display:none;"></div>
</div>

<script>
const loading=document.getElementById('loading-overlay');
const loadingProgress=document.getElementById('loadingProgress');

// JSON内のすべての画像URLを抽出してプリロード
window.addEventListener("load", () => {
  const imageUrls = new Set();

  quizData.forEach(q => {
    if (q.image) imageUrls.add(q.image);
    q.options?.forEach(opt => {
      if (opt.image) imageUrls.add(opt.image);
    });
  });

  imageUrls.forEach(src => {
    const img = new Image();
    img.src = src;
  });
});

let currentIndex=0;
let answered=false;
let timerTimeout;
let startTime, endTime;
let timeLeftMs = 0;

const quizNo=document.getElementById('quiz-no');
const questionBox=document.getElementById('question');
const buttonsDiv=document.getElementById('buttons');
const timerProgress=document.getElementById('timerProgress');

function startTimer(){
  startTime = Date.now();
  endTime = startTime + 10000; // 10秒
  timerProgress.style.transition="none";
  timerProgress.style.width="100%";
  setTimeout(()=>{
    timerProgress.style.transition="width 10s linear";
    timerProgress.style.width="0%";
  },50);

  timerTimeout=setTimeout(()=>{
    if(!answered) handleAnswer(null);
  },10000);
}

function stopTimer(){
  clearTimeout(timerTimeout);
  const now = Date.now();
  timeLeftMs = Math.max(endTime - now, 0); // 残りミリ秒
  const computedStyle=window.getComputedStyle(timerProgress);
  const width=computedStyle.width;
  timerProgress.style.transition="none";
  timerProgress.style.width=width;
}

//2枚目の画像切替用タイマー
let imageSwitchTimer;

function showQuestion(){
  answered=false;
  
  clearTimeout(imageSwitchTimer);
  
  const q=quizData[currentIndex];
  quizNo.innerHTML="Q" + (currentIndex + 1) + "　" + q.quiztype;
  questionBox.innerHTML=q.question + (q.image?`<br><img src="${q.image}" class="quiz-img">`:"");
  buttonsDiv.innerHTML="";
  q.options.forEach(opt=>{
    const btn=document.createElement('button');
    btn.innerHTML=opt.text;
    btn.onclick=()=>handleAnswer(opt.text);
    buttonsDiv.appendChild(btn);
  });
  initButtonTouchEvents();
  startTimer();
  
  if (q.image2 && q.image2time) {
    const switchMs = q.image2time;
    imageSwitchTimer = setTimeout(() => {
      const img = questionBox.querySelector('.quiz-img');
      if (img && !answered) {
        img.src = q.image2;
      }
    }, switchMs);
  }
}


const rankText = document.getElementById('rankText');
const rankHighlight = document.getElementById('rankTextHighlight');
const cutinScoreValue=document.getElementById('cutinScoreValue');

function handleAnswer(selected){
  if(answered) return;
  answered=true;
  stopTimer();
  const q=quizData[currentIndex];
  const isCorrect=(selected===q.correct);
  Array.from(buttonsDiv.children).forEach(btn=>{
    if(btn.textContent.includes(selected)) btn.classList.add('pressed');
  });
  
  if(isCorrect && q.answerstart > timeLeftMs){
    var gained = 0;
    var cutinTitle = "";
    
    if(q.perfect < timeLeftMs){
      gained = 600;
      cutinTitle = "PERFECT!!"
      setRankStyle('pinkgold');
      
    }else if(q.excellent < timeLeftMs){
      //ポイント＝評価基礎点＋評価倍率×評価範囲の​下限超過時間​（％）​
      gained = 500 + Math.floor(5 * (timeLeftMs - q.excellent) / q.answerstart * 100);
      cutinTitle = "EXCELLENT!"
      setRankStyle('rainbow');
      
    }else if(q.great < timeLeftMs){
      gained = 300 + Math.floor(3 * (timeLeftMs - q.great) / q.answerstart * 100);
      cutinTitle = "GREAT!"
      setRankStyle('gold');
      
    }else if(q.good < timeLeftMs){
      gained = 200 + Math.floor(2 * (timeLeftMs - q.good) / q.answerstart * 100);
      cutinTitle = "GOOD"
      setRankStyle('silver');
      
    }else{
      gained = 100 + Math.floor(1 * timeLeftMs / q.answerstart * 100);
      cutinTitle = "SAFE"
      setRankStyle('silver');
      
    }
    
    addScore(gained);
    
    showCutIn(isCorrect, cutinTitle);
  }else{
    
    cutinScoreValue.textContent = '0';
    showCutIn(false, "BAD..");
    setRankStyle('blue');
    
  }
}


let score = 0;
let displayScore = 0;
const scoreEl = document.querySelector('.score-value');

function addScore(amount) {
  const start = score;
  const end = score + amount;
  score = end;
  
  cutinScoreValue.textContent = amount;
  
  const step = () => {
    if (displayScore < score) {
      displayScore += Math.ceil((score - displayScore) / 10); // 徐々に追いつく
      scoreEl.textContent = displayScore.toString().padStart(4, '0');
      requestAnimationFrame(step);
    } else {
      scoreEl.textContent = score.toString().padStart(4, '0');
    }
  };
  requestAnimationFrame(step);
}

function setRankStyle(style) {
  rankText.setAttribute("fill", `url(#${style})`);
  rankTextHighlight.setAttribute("fill", `url(#${style})`);
}

function showCutIn(isCorrect, text) {
  const cutin = document.querySelector('.cutin');
  const score = document.querySelector('.cutin-score');

  // 前回のアニメをリセット
  cutin.classList.remove('cutin', 'correct', 'wrong');
  void cutin.offsetWidth; // ★ 強制reflow：これで確実にリセット
  cutin.classList.add('cutin', isCorrect ? 'correct' : 'wrong');
  
  rankText.textContent = text;
  rankHighlight.textContent = text;
  cutin.classList.remove('disappear');
  // アニメ発動
  cutin.classList.add('active');
  // 進捗バー更新
  const segments = document.querySelectorAll('.stage-progress-segment');
  if (segments[stageQuizIdx]) segments[stageQuizIdx].classList.add('filled');

  // 終了処理（帯拡大アニメーション終了後に非表示）

      setTimeout(() => {
        cutin.classList.remove('active');
        cutin.classList.add('disappear');
        
        currentIndex++;
        stageQuizIdx++;
    
        if (currentIndex < quizData.length){
          if (stageQuizIdx >= nowStage.count){
            stageCount++;
            nowStage = stageData[stageCount];
            showNextStage();
          }else{
            showQuestion();
          }
        }else{
          endQuiz();
        }
        
      }, 1500);
}

var stageCount = 0;
var stageQuizIdx = 0;
var nowStage = stageData[0];


function createProgressSegments(segmentCount) {
  const stageProgress = document.querySelector('.stage-progress');
  stageProgress.innerHTML = ''; // 既存をクリア
  
  for (let i = 0; i < segmentCount; i++) {
    const seg = document.createElement('div');
    seg.className = 'stage-progress-segment';
    stageProgress.appendChild(seg);
  }
}

const stageOverlay = document.getElementById('stage-overlay');
const stageOverlayTitle = document.getElementById('stage-overlay-title');
const stageOverlayLoading = document.getElementById('stage-overlay-loading');
const stageText = document.getElementById('stage-title');
const stageProgress = document.getElementById('stageProgress');
  
function showNextStage(){

  document.getElementById('quiz-header').style.display = "none";
  document.getElementById('question').style.display = "none";
  document.getElementById('timer-container').style.display = "none";
  document.getElementById('buttons').style.display = "none";
  
  stageOverlayTitle.style.display = "none";
  stageOverlayLoading.style.display = "";
  
  stageOverlay.style.opacity='1';
  stageOverlay.style.display='';
  stageText.style.display='none';
  
  stageQuizIdx=0;
  
  stageText.textContent = `STAGE ` + nowStage.stage;
  
  document.getElementById('loading-msg').textContent = nowStage.loadMsg;
  
  stageProgress.style.width = "0%";
  stageOverlay.style.display = "flex";

  let progress = 0;
  stageProgress.style.transition = "none";
  stageProgress.style.width = "0%";

  const timer = setInterval(() => {
    // ランダムに進行量を変える（1/2は進行なし、1/2は0～9％）
    var upPt = Math.random() * 18 - 9;
    if(upPt < 0) upPt = 0;
    progress += upPt;
    if (progress >= 100) progress = 100;

    // 更新のたびに短いトランジションで滑らかに
    stageProgress.style.transition = "width 0.2s ease-out";
    stageProgress.style.width = progress + "%";

    // 100%に到達したら完了処理
    if (progress >= 100) {
      clearInterval(timer);
      
      setTimeout(() => {
        createProgressSegments(nowStage.count);
        document.getElementById('stage-info-title').textContent = `STAGE ` + nowStage.stage;
        stageOverlayTitle.style.display = "";
        stageOverlayLoading.style.display = "none";
        stageText.style.display = '';
        document.getElementById('stage-msg').textContent = nowStage.startMsg;
        stageProgress.style.width = "0%";

        setTimeout(() => {
          count = 3;
          showCountdown();
        }, 2000);
      }, 1000);
    }
  }, 100); 
}

createProgressSegments(1);
showNextStage();

// --- カウントダウン処理 ---
const overlay=document.getElementById('countdown-overlay');
const countNum=document.getElementById('countNum');
const container=document.querySelector('.container');
let count=3;

function showCountdown(){
  countNum.textContent=count;
  countNum.style.opacity='1';
  countNum.style.animation='moveUp 1s ease';
  
  countNum.addEventListener('animationend',()=>{
    countNum.style.animation='none';
    countNum.style.opacity='0';
    count--;
  
    if(count>0){
      setTimeout(showCountdown,150);
    }else{
    
      stageOverlay.style.transition='opacity .5s';
      stageOverlay.style.opacity='0';
      countNum.style.opacity='0';
      
      setTimeout(()=>{
        stageOverlay.style.display='none';
      
        document.getElementById('quiz-header').style.display = "";
        document.getElementById('question').style.display = "";
        document.getElementById('timer-container').style.display = "";
        document.getElementById('buttons').style.display = "";
        
        showQuestion();
      },500);
    }
  },{once:true});
}


function endQuiz(){
  stopTimer();
  
  // 白フェード用のdivを生成
  const fade = document.createElement('div');
  fade.style.position = 'fixed';
  fade.style.top = 0;
  fade.style.left = 0;
  fade.style.width = '100%';
  fade.style.height = '100%';
  fade.style.backgroundColor = '#fff';
  fade.style.opacity = '0';
  fade.style.transition = 'opacity 3s';
  fade.style.zIndex = 9999;
  document.body.appendChild(fade);
  
  // 100ms遅延してからフェード開始
  setTimeout(() => {
    fade.style.opacity = 1;
  }, 100);

  setTimeout(() => {
    window.location.href = 'result.html#score=' + score; // 遷移先HTMLを指定
  }, 3500);
}


// ==== スマホ向けボタン押下制御 ====
function initButtonTouchEvents() {
  const buttons = document.querySelectorAll('.buttons button');
  buttons.forEach(btn => {
    let isInside = false;

    btn.addEventListener('touchstart', () => {
      isInside = true;
      btn.classList.add('pressed');
    });

    btn.addEventListener('touchmove', e => {
      const touch = e.touches[0];
      const rect = btn.getBoundingClientRect();
      const inside =
        touch.clientX >= rect.left &&
        touch.clientX <= rect.right &&
        touch.clientY >= rect.top &&
        touch.clientY <= rect.bottom;
      if (inside && !isInside) {
        btn.classList.add('pressed');
        isInside = true;
      } else if (!inside && isInside) {
        btn.classList.remove('pressed');
        isInside = false;
      }
    });

    btn.addEventListener('touchend', () => {
      if (isInside) {
        //btn.classList.remove('pressed');
        btn.click();
      } else {
        btn.classList.remove('pressed');
      }
      isInside = false;
    });
  });
}

</script>
</body>
</html>