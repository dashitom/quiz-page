<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<link rel="stylesheet" href="style.css">
<link rel="apple-touch-icon" href="apple-touch-icon.png">
<title>AI脳トレ</title>
<script>
// --- 問題データ ---
const quizData=[
  {"stage":"1","mode":"","quiztype":"計算力","beforeTxt":"","beforeImg":"","beforeMusic":"","beforeTime":"","question":"１＋１＝？","image":"","image2":"","image2time":"","options":[{"text":"1"},{"text":"2"},{"text":""},{"text":""}],"correct":"2","answertime":20000,"answerstart":20000,"perfect":19000,"excellent":15000,"great":10000,"good":5000,"safe":0},
  {"stage":"2","mode":"","quiztype":"色彩認識力","beforeTxt":"","beforeImg":"","beforeMusic":"","beforeTime":"","question":"ピクセル数が多いのは？","image":"images/dot1.png","image2":"","image2time":"","options":[{"text":"黒"},{"text":"黄"},{"text":""},{"text":""}],"correct":"黄","answertime":20000,"answerstart":20000,"perfect":19000,"excellent":15000,"great":10000,"good":5000,"safe":0},
  {"stage":"3","mode":"","quiztype":"パターン認識力","beforeTxt":"","beforeImg":"","beforeMusic":"","beforeTime":"","question":"？にあてはまるのは","image":"images/num1.png","image2":"","image2time":"","options":[{"text":"1"},{"text":"2"},{"text":"3"},{"text":"4"}],"correct":"2","answertime":20000,"answerstart":20000,"perfect":19000,"excellent":15000,"great":10000,"good":5000,"safe":0},
  {"stage":"4","mode":"renda","quiztype":"運動神経伝達力","beforeTxt":"","beforeImg":"","beforeMusic":"","beforeTime":"","question":"連打して！","image":"images/yubirenda.png","image2":"","image2time":"","options":[{"text":"連打!"},{"text":""},{"text":""},{"text":""}],"correct":"","answertime":5000,"answerstart":5000,"perfect":50,"excellent":40,"great":30,"good":20,"safe":10},
  {"stage":"5","mode":"","quiztype":"注意力","beforeTxt":"","beforeImg":"","beforeMusic":"","beforeTime":"","question":"文字数が多いのは？","image":"images/ty.png","image2":"","image2time":"","options":[{"text":"T"},{"text":"Y"},{"text":""},{"text":""}],"correct":"Y","answertime":20000,"answerstart":20000,"perfect":19000,"excellent":15000,"great":10000,"good":5000,"safe":0},
];

// --- ステージ情報 ---
const stageData=[
  {"stage":"1", "loadMsg":"問題を作成しています…", "startMsg":"まずは肩慣らしです。"},
  {"stage":"2", "loadMsg":"あなたの回答を分析しています…", "startMsg":"少しレベルを上げます！"},
  {"stage":"3", "loadMsg":"さらに分析しています…", "startMsg":"やりますね！さらにレベルアップ！"},
  {"stage":"4", "loadMsg":"あなたにあわせて調整しています…", "startMsg":"あなたに合った問題を作成しました！"},
  {"stage":"5", "loadMsg":"完全にあなたを理解しました…", "startMsg":"レベルMAX！最終ステージです！"},
]
</script>
</head>
<body>
<audio id="bgm" src="bgm/Specification.mp3" loop></audio>
<audio id="se_count" src="bgm/count.mp3"></audio>

<div id="first-confirm" >
  <b>AI脳トレへようこそ ver6</b><br>
  このアプリはあなたの回答をもとに<br>
  あなただけの脳トレーニングを<br>
  実行します。
  <br>
  <br>
  一部の問題は音声を使用して出題されます。<br>
  ヘッドホンを利用するか、ミュートの解除をお願いします。<br>
  <br>
  このウインドウはもうちょっとカッコよくします
  <br>
  <div id="first-confirm-buttons" >
    <button onclick="this.classList.add('pressed');init();">START</button>
    <button id='back' onclick="this.classList.add('pressed');location.href = 'ainoutre.html';">戻る</button>
  </div>
</div>

<div class="cutin">
  <div class="cutin-content">
    <img src="images/batsu.png" class="cutin-img" style="display:none;">
    <svg id="countSvg" >
      <text id="cutinCountTxtBG" x="50%" y="50%" text-anchor="middle" dominant-baseline="middle"
            fill="url(#white)" stroke="#fff" stroke-width="17" stroke-linejoin="round">
        0.32 sec
      </text>
      <!-- メイン文字 -->
      <text id="cutinCountTxt" x="50%" y="50%" text-anchor="middle" dominant-baseline="middle"
            fill="url(#white)" stroke="#333" stroke-width="15" stroke-linejoin="round">
        0.32 sec
      </text>
      <!-- 光沢ハイライト -->
      <text id="cutinCountTxtHighlight" x="50%" y="50%" text-anchor="middle" dominant-baseline="middle"
            fill="url(#white)" stroke="rgba(255,255,255,1)" stroke-width="1">
        0.32 sec
      </text>
    </svg>
    <svg id="rankSvg" >
      <defs>
        <!-- 各グラデーション定義 -->
        <linearGradient id="pinkgold" x1="0%" y1="0%" x2="0%" y2="100%">
          <stop offset="0%" stop-color="#ffe6f2"/>
          <stop offset="25%" stop-color="#ffb3d9"/>
          <stop offset="50%" stop-color="#ff99cc"/>
          <stop offset="75%" stop-color="#ff66b3"/>
          <stop offset="100%" stop-color="#ffd6e6"/>
        </linearGradient>
      
        <linearGradient id="rainbow" x1="0%" y1="0%" x2="0%" y2="100%">
          <stop offset="0%" stop-color="#ff8080"/>
          <stop offset="16%" stop-color="#ffc080"/>
          <stop offset="33%" stop-color="#ffff80"/>
          <stop offset="50%" stop-color="#80ff80"/>
          <stop offset="66%" stop-color="#80ffff"/>
          <stop offset="83%" stop-color="#8080ff"/>
          <stop offset="100%" stop-color="#ff80ff"/>
        </linearGradient>

        <linearGradient id="gold" x1="0%" y1="0%" x2="0%" y2="100%">
          <stop offset="0%" stop-color="#fff2a8"/>
          <stop offset="30%" stop-color="#ffd700"/>
          <stop offset="60%" stop-color="#caa400"/>
          <stop offset="100%" stop-color="#fff4b3"/>
        </linearGradient>

        <linearGradient id="silver" x1="0%" y1="0%" x2="0%" y2="100%">
          <stop offset="0%" stop-color="#ffffff"/>
          <stop offset="30%" stop-color="#d9d9d9"/>
          <stop offset="60%" stop-color="#b0b0b0"/>
          <stop offset="100%" stop-color="#e6e6e6"/>
        </linearGradient>

        <linearGradient id="bronze" x1="0%" y1="0%" x2="0%" y2="100%">
          <stop offset="0%" stop-color="#ffe0b3"/>
          <stop offset="30%" stop-color="#cd7f32"/>
          <stop offset="60%" stop-color="#8b4513"/>
          <stop offset="100%" stop-color="#ffcc99"/>
        </linearGradient>
        
        <linearGradient id="blue" x1="0%" y1="0%" x2="0%" y2="100%">
          <stop offset="0%" stop-color="#e0f7ff"/>
          <stop offset="30%" stop-color="#66ccff"/>
          <stop offset="60%" stop-color="#3399ff"/>
          <stop offset="100%" stop-color="#0066cc"/>
        </linearGradient>
        
        <linearGradient id="white" x1="0%" y1="0%" x2="0%" y2="100%">
          <stop offset="0%" stop-color="#fff"/>
          <stop offset="49%" stop-color="#fff"/>
          <stop offset="51%" stop-color="#B4FFFF"/>
          <stop offset="100%" stop-color="#B4FFFF"/>
        </linearGradient>
      </defs>

      <text id="rankTextBG" x="50%" y="50%" text-anchor="middle" dominant-baseline="middle"
            fill="url(#rainbow)" stroke="#fff" stroke-width="12" stroke-linejoin="round">
        EXCELLENT!
      </text>
      <!-- メイン文字 -->
      <text id="rankText" x="50%" y="50%" text-anchor="middle" dominant-baseline="middle"
            fill="url(#rainbow)" stroke="#333" stroke-width="10" stroke-linejoin="round">
        EXCELLENT!
      </text>
      <!-- 光沢ハイライト -->
      <text id="rankTextHighlight" x="50%" y="50%" text-anchor="middle" dominant-baseline="middle"
            fill="url(#rainbow)" stroke="rgba(255,255,255,1)" stroke-width="1">
        EXCELLENT!
      </text>
    </svg>
    <div class="cutin-score">スコア&nbsp;<span id="cutinScoreValue">9999</span></div>
  </div>
</div>

<div id="stage-overlay" style="display:none;">
  <div id="stage-overlay-title" >
    <div id="stage-title" >STAGE 1</div>
    <div id="stage-msg" ></div>
    <div class="count-number" id="countNum" >3</div>
  </div>
  <div id="stage-overlay-loading" >
    <div id="loading-msg" ></div>
    <div class="loading-bar" id="loadingBar" ><div class="loading-progress" id="stageProgress"></div></div>
  </div>
</div>

<div class="container" >
  <!-- === ステージ情報バー === -->
  <div class="stage-info">
    <div class="stage-left" id="stage-info-title">STAGE 1</div>
    <div class="stage-center">
      <div class="stage-progress"></div>
    </div>
    <div class="stage-right">
      <span class="score-label">スコア</span>
      <span class="score-value">00000</span>
    </div>
  </div>
  <div class="quiz-header" id="quiz-header" style="display:none;">
    <span id="quiz-no"></span>
  </div>
  <div class="question-box" id="question" style="display:none;"></div>
  <div class="timer-container" id="timer-container" style="display:none;">
    <div class="timer-label">TIME</div>
    <div class="timer-bar"><div class="timer-progress" id="timerProgress"></div></div>
  </div>
  <div class="buttons" id="buttons" style="display:none;"></div>
  <div class="banner" id="banner" style=""></div>
  <div id="sukaText">スカ！</div>
</div>

<script>
const loading=document.getElementById('loading-overlay');
const loadingProgress=document.getElementById('loadingProgress');

// JSON内のすべての画像URLを抽出してプリロード
window.addEventListener("load", () => {
  //音声プリロード
  preloadSounds(['count','point','seikai','huseikai','hit']);

  //初回確認を表示し、裏でプリロード
  document.getElementById('first-confirm').style.opacity = '1';
  document.getElementById('first-confirm').style.transform = 'translateY(0)';

  const imageUrls = new Set();
  imageUrls.add('images/maru.png');
  imageUrls.add('images/batsu.png');
  imageUrls.add('images/renda.png');
  imageUrls.add('images/mikiri.png');
  imageUrls.add('images/mikiri_press.png');
  //ボタン用
  imageUrls.add('images/goo.png');
  imageUrls.add('images/tyoki.png');
  imageUrls.add('images/paa.png');
  
  quizData.forEach(q => {
    if (q.beforeImg) imageUrls.add(q.beforeImg);
    if (q.image) imageUrls.add(q.image);
    if (q.image2) imageUrls.add(q.image2);
    q.options?.forEach(opt => {
      if (opt.image) imageUrls.add(opt.image);
    });
  });

  imageUrls.forEach(src => {
    const img = new Image();
    img.src = src;
  });
});

let currentIndex=0;
let answered=false;
let timerTimeout;
let startTime, endTime;
let timeLeftMs = 0;
let tapTime = 0;

const quizNo=document.getElementById('quiz-no');
const questionBox=document.getElementById('question');
const buttonsDiv=document.getElementById('buttons');
const timerLabel = document.querySelector('.timer-label');
const timerBar = document.querySelector('.timer-bar');
const timerProgress=document.getElementById('timerProgress');

let timerFrame;

function hideTimer(){
  timerLabel.style.display = 'none';
  timerBar.style.display = 'none';
}

function startTimer(){
  const duration = q.answertime;
  startTime = Date.now();
  endTime = startTime + duration; 
  cancelAnimationFrame(timerFrame); // 前のループを止める
  
  timerLabel.style.display = '';
  timerProgress.style.transition = "none";
  timerProgress.style.width = "100%";
  timerBar.style.display = '';
  void timerProgress.offsetWidth;

  function update(now){
    const elapsed = now - start;
    const progress = Math.max(0, 1 - elapsed / duration);
    timerProgress.style.width = (progress * 100) + "%";

    // 緑→黄→赤 のグラデーション補間
    const color = getProgressColor(progress);
    timerProgress.style.backgroundColor = color;

    if (!answered) {
      if (elapsed < duration){
        timerFrame = requestAnimationFrame(update);
      } else {
      
        if(q.mode=='renda'){
          rendaResult();
        }else{
          handleAnswer(null);
        }
      }
    }
  }
  
  const start = performance.now();
  timerFrame = requestAnimationFrame(update);
}

function getProgressColor(progress) {
  if (progress > q.great / q.answertime) {
    return "#a8e6a1"; // パステルグリーン
  } else if (progress > q.good / q.answertime) {
    return "#fff59d"; // パステルイエロー
  } else {
    return "#ff9e9e"; // パステルレッド
  }
}

function stopTimer() {
  clearTimeout(timerTimeout);
  const now = Date.now();
  timeLeftMs = Math.max(endTime - now, 0); // 残りミリ秒
  tapTime = Math.max(now - startTime, 0); // 経過ミリ秒

  const computedStyle = window.getComputedStyle(timerProgress);
  const widthPx = parseFloat(computedStyle.width);
  const parentWidth = timerProgress.parentElement.offsetWidth;
  const widthPercent = (widthPx / parentWidth) * 100;

  timerProgress.style.transition = "none";
  timerProgress.style.width = `${widthPercent}%`;
}


//2枚目の画像切替用タイマー
let imageSwitchTimer;

let q;
let rendaCount;


//出題処理
function showQuestion(){
  answered=false;

  startTime = 0;
  
  clearTimeout(imageSwitchTimer);
  
  q=quizData[currentIndex];
  quizNo.innerHTML="Q" + (currentIndex + 1) + "　" + q.quiztype;
  
  if(q.question=="今何問目？"){
    quizNo.innerHTML="Q？" + "　" + q.quiztype;
  }
  
  rendaCount = 0;
  
  if(q.mode=='renda'){
    questionBox.innerHTML=q.question + (q.image?`<br><img src="${q.image}" class="quiz-img">`:"");
    hideTimer();
    buttonsDiv.innerHTML="";
    buttonsDiv.className = 'buttons';
    
    startQuizCountdown();

  }else if(q.beforeTxt != '' || q.beforeImg != ''){
    questionBox.innerHTML=q.question + (q.beforeImg?`<br><img src="${q.beforeImg}" class="quiz-img">`:"");
    hideTimer();
    
    if(q.mode=='mikiri'){
      setButtons();
    }else{
      buttonsDiv.innerHTML="";
      buttonsDiv.className = 'buttons';
    }
    
    setTimeout(()=>{
      showQuestionMain();
    },q.beforeTime);
    
  }else{
    showQuestionMain();
  }
}

//出題時カウントダウン処理(連打用)
let quizCountNum;
let quizCountdownCount=3;

function startQuizCountdown(){
  buttonsDiv.innerHTML='<div class="count-number" id="quizCountNum" >3</div>';
  quizCountNum = document.querySelector('#quizCountNum');
  quizCountdownCount=3;
  showQuizCountdown();
}

function showQuizCountdown(){
  quizCountNum.textContent=quizCountdownCount;
  quizCountNum.style.opacity='1';
  quizCountNum.style.animation='moveUp 1s ease';
  playSound('count');
  
  quizCountNum.addEventListener('animationend',()=>{
    quizCountNum.style.animation='none';
    quizCountNum.style.opacity='0';
    quizCountdownCount--;
  
    if(quizCountdownCount>0){
      setTimeout(showQuizCountdown,150);
    }else{
      quizCountNum.style.opacity='0';
      
      setTimeout(()=>{
        showQuestionMain();
      },500);
    }
  },{once:true});
}

function showQuestionMain(){

  questionBox.innerHTML=q.question + (q.image?`<br><img src="${q.image}" class="quiz-img">`:"");
  setButtons();

  if(q.mode=='renda'){
    setRenda();
  }
  
  initButtonTouchEvents();
  startTimer();
  
  if (q.image2 && q.image2time) {
    const switchMs = q.image2time;
    imageSwitchTimer = setTimeout(() => {
      const img = questionBox.querySelector('.quiz-img');
      if (img && !answered) {
        img.src = q.image2;
      }
    }, switchMs);
  }
}

function setButtons(){
  buttonsDiv.innerHTML="";
  q.options.forEach((opt, i) => {
    if(opt.text != ''){
      const btn=document.createElement('button');

      if (opt.text.endsWith('.png')) {
        btn.style.backgroundImage = `url(${opt.text})`;
        btn.textContent = '';
        
        btn.style.backgroundSize = 'calc(100% - 24px) auto';
        btn.style.backgroundRepeat = 'no-repeat';
        btn.style.backgroundPosition = 'center';
        btn.style.padding = '10px'; 
      } else {
        btn.textContent = opt.text;
      }

      if(opt.text.length==3){
        btn.classList.add('three-word');
      }
      
      btn.onclick=()=> {
        if(q.mode=='renda'){
          handleRenda(opt.text);
        }else if(startTime==0){
          suka();
        }else{
          handleAnswer(opt.text);
        }
      };
      
      buttonsDiv.appendChild(btn);
    }
  });
  // ボタン数でクラスを切り替え
  const count = buttonsDiv.querySelectorAll('button').length;
  buttonsDiv.className = 'buttons ' + (count <= 3 ? 'one-row ' : 'two-row ') + q.mode;
}

function suka(){
  addScore(-100);

  const sukaText = document.getElementById('sukaText');
  sukaText.style.display = 'block';

  playSound('huseikai');

  setTimeout(() => {
    sukaText.style.display = 'none';
    Array.from(buttonsDiv.children).forEach(btn=>{
      btn.classList.remove('pressed');
    });
  }, 500);
}

function setRenda(){

  rendaCount = 0;

  questionBox.innerHTML=q.question + `<br><img src="${q.image}" class="quiz-img"><div id="tap-gauge"><div id="tap-count">0</div><div id="tap-fill"></div></div>`
  document.getElementById('tap-fill').style.display = 'none';
  buttonsDiv.innerHTML="";
  q.options.forEach((opt, i) => {
    if(opt.text != ''){
      const btn=document.createElement('button');
      btn.innerHTML=opt.text;
      
      btn.onclick=()=> {
        handleRenda(opt.text);
      };
      
      buttonsDiv.appendChild(btn);
    }
  });
  

}

function handleRenda(selected){

  //連打するので押したボタンはすぐ引っ込む
  setTimeout(() => {
    Array.from(buttonsDiv.children).forEach(btn=>{
      btn.classList.remove('pressed');
    });
  }, 50);
  
  if(answered) return;
      
  rendaCount++;
          
  // シェイク演出
  const img = questionBox.querySelector('.quiz-img');
  img.classList.remove('shake');
  void img.offsetWidth; // ← 強制リフローで再適用可能に
  img.classList.add('shake');

  playSound('hit');
    
  if (q.image2) {
    if(rendaCount % 2 === 0){
      img.src = q.image;
    }else{
      img.src = q.image2;
    }
  }
  
  var bg = document.getElementById('tap-gauge');
  var fill = document.getElementById('tap-fill');
  var count = document.getElementById('tap-count');

  fill.style.display = '';
  
  var percent;
  
  if(q.perfect <= rendaCount){
    percent = 1;
    fill.style.background = 'var(--pastel-red)';
  }else if(q.excellent < rendaCount){
    percent = (rendaCount - q.excellent) / (q.perfect - q.excellent);
    fill.style.background = 'var(--pastel-red)';
    bg.style.background = 'var(--pastel-orange)';
  }else if(q.great < rendaCount){
    percent = (rendaCount - q.great) / (q.excellent - q.great);
    fill.style.background = 'var(--pastel-orange)';
    bg.style.background = 'var(--pastel-yellow)';
  }else if(q.good < rendaCount){
    percent = (rendaCount - q.good) / (q.great - q.good);
    fill.style.background = 'var(--pastel-yellow)';
    bg.style.background = 'var(--pastel-green)';
  }else if(q.safe < rendaCount){
    percent = (rendaCount - q.safe) / (q.good - q.safe);
    fill.style.background = 'var(--pastel-green)';
    bg.style.background = 'var(--pastel-blue)';
  }else{
    percent = rendaCount / q.safe;
    fill.style.background = 'var(--pastel-blue)';
    bg.style.background = '#fff';
  }
  
  fill.style.height = percent * 100 + "%";
  count.textContent = rendaCount;

  if(q.perfect <= rendaCount){
    rendaResult();
  }
}


const rankTextBG = document.getElementById('rankTextBG');
const rankText = document.getElementById('rankText');
const rankHighlight = document.getElementById('rankTextHighlight');
const cutinScoreValue=document.getElementById('cutinScoreValue');

function handleAnswer(selected){

  if(answered) return;
  answered=true;
  stopTimer();
  const q=quizData[currentIndex];
  const isCorrect=(selected===q.correct);
  Array.from(buttonsDiv.children).forEach(btn=>{
    if(btn.textContent.includes(selected)) btn.classList.add('pressed');
  });

  if(isCorrect){
    playSound('seikai');
    playSound('point', 0.5);
  }else{
    playSound('huseikai');
  }
  
  if(isCorrect && q.answerstart > timeLeftMs){
    var gained = 0;
    var cutinTitle = "";
    
    if(q.perfect < timeLeftMs){
      gained = 600;
      cutinTitle = "PERFECT!!"
      setRankStyle('pinkgold');
      
    }else if(q.excellent < timeLeftMs){
      //ポイント＝評価基礎点＋評価倍率×評価範囲の​下限超過時間​（％）​
      gained = 500 + Math.floor(5 * (timeLeftMs - q.excellent) / q.answerstart * 100);
      cutinTitle = "EXCELLENT!"
      setRankStyle('rainbow');
      
    }else if(q.great < timeLeftMs){
      gained = 300 + Math.floor(3 * (timeLeftMs - q.great) / q.answerstart * 100);
      cutinTitle = "GREAT!"
      setRankStyle('gold');
      
    }else if(q.good < timeLeftMs){
      gained = 200 + Math.floor(2 * (timeLeftMs - q.good) / q.answerstart * 100);
      cutinTitle = "GOOD"
      setRankStyle('silver');
      
    }else{
      gained = 100 + Math.floor(1 * timeLeftMs / q.answerstart * 100);
      cutinTitle = "SAFE"
      setRankStyle('bronze');
      
    }
    
    addScore(gained);
    
    showCutIn(isCorrect, cutinTitle);
  }else{
    
    cutinScoreValue.textContent = '0';
    showCutIn(false, "BAD");
    setRankStyle('blue');
    
  }
}

function rendaResult(){

  answered=true;
  stopTimer();
  const q=quizData[currentIndex];
  
    if(q.perfect <= rendaCount){
      gained = 600;
      cutinTitle = "PERFECT!!"
      setRankStyle('pinkgold');
      
    }else if(q.excellent <= rendaCount){
      //ポイント＝評価基礎点＋評価倍率×評価範囲の​下限超過時間​（％）​
      gained = 500 + Math.floor(5 * (rendaCount - q.excellent) / (q.perfect - q.excellent));
      cutinTitle = "EXCELLENT!"
      setRankStyle('rainbow');
      
    }else if(q.great <= rendaCount){
      gained = 300 + Math.floor(3 * (rendaCount - q.great) / (q.excellent - q.great));
      cutinTitle = "GREAT!"
      setRankStyle('gold');
      
    }else if(q.good <= rendaCount){
      gained = 200 + Math.floor(2 * (rendaCount - q.good) / (q.great - q.good));
      cutinTitle = "GOOD"
      setRankStyle('silver');
      
    }else if(q.safe <= rendaCount){
      gained = 100 + Math.floor(1 * (rendaCount - q.safe) / (q.good - q.safe));
      cutinTitle = "SAFE"
      setRankStyle('bronze');
      
    }else{
      gained = 0;
      cutinTitle = "BAD"
      setRankStyle('blue');
    }

    if(cutinTitle != "BAD"){
      playSound('seikai');
      playSound('point', 0.5);
    }else{
      playSound('huseikai');
    }
    
    addScore(gained);
    
    showCutIn(true, cutinTitle);
}

let score = 0;
let displayScore = 0;
const scoreEl = document.querySelector('.score-value');

function addScore(amount) {
  const start = displayScore;
  score = Math.max(0, score + amount); // マイナスにならないよう制限

  const step = () => {
    const diff = score - displayScore;
    if (diff !== 0) {
      displayScore += diff > 0 ? Math.ceil(diff / 10) : Math.floor(diff / 10);
      // 1万以下は0埋め5桁表示
      scoreEl.textContent = score <= 99999
        ? displayScore.toString().padStart(5, '0')
        : displayScore.toString();
      cutinScoreValue.textContent = (displayScore - start).toString();
      requestAnimationFrame(step);
    } else {
      scoreEl.textContent = score <= 99999
        ? score.toString().padStart(5, '0')
        : score.toString();
      cutinScoreValue.textContent = amount.toString();
    }
  };
  requestAnimationFrame(step);
}

function setRankStyle(style) {
  rankText.setAttribute("fill", `url(#${style})`);
  rankTextHighlight.setAttribute("fill", `url(#${style})`);
}

function showCutIn(isCorrect, text) {
  const cutin = document.querySelector('.cutin');
  const cutinImg = document.querySelector('.cutin-img');
  const countSvg = document.getElementById('countSvg');
  
  const cutinCountTxtBG = document.querySelector('#cutinCountTxtBG');
  const cutinCountTxt = document.querySelector('#cutinCountTxt');
  const cutinCountTxtHighlight = document.querySelector('#cutinCountTxtHighlight');
  
  const score = document.querySelector('.cutin-score');

  // 前回のアニメをリセット
  cutin.classList.remove('cutin', 'correct', 'wrong');
  void cutin.offsetWidth; // ★ 強制reflow：これで確実にリセット
  cutin.classList.add('cutin', isCorrect ? 'correct' : 'wrong');
  
  if(q.mode=='renda' || q.mode=='mikiri'){
    countSvg.style.display = '';
    cutinImg.style.display = 'none';
    
    if(q.mode=='renda'){
      cutinCountTxtBG.textContent = rendaCount + '回';
      cutinCountTxt.textContent = rendaCount + '回';
      cutinCountTxtHighlight.textContent = rendaCount + '回';
    }else if(q.mode=='mikiri'){
      let tapTimeSec = (Math.round((tapTime / 1000) * 100) / 100) + ' sec';
      if(!isCorrect){
        tapTimeSec = 'MISS'
      }
      cutinCountTxtBG.textContent = tapTimeSec;
      cutinCountTxt.textContent = tapTimeSec;
      cutinCountTxtHighlight.textContent = tapTimeSec;
    }
    
  }else{
    countSvg.style.display = 'none';
    cutinImg.style.display = '';
    
    if(isCorrect){
      cutinImg.src = 'images/maru.png';
    } else {
      cutinImg.src = 'images/batsu.png';
    }
  }
  
  rankTextBG.textContent = text;
  rankText.textContent = text;
  rankHighlight.textContent = text;
  
  cutin.classList.remove('disappear');
  // アニメ発動
  cutin.classList.add('active');
  // 進捗バー更新
  const segments = document.querySelectorAll('.stage-progress-segment');
  if (segments[stageQuizIdx]) segments[stageQuizIdx].classList.add('filled');

  // 終了処理（帯拡大アニメーション終了後に非表示）

  setTimeout(() => {
    cutin.classList.add('disappear');        
  }, 1750);
      
  setTimeout(() => {
    cutin.classList.remove('active');
  
    currentIndex++;
    stageQuizIdx++;
    
    if (currentIndex < quizData.length){
      if (stageQuizIdx >= nowStage.count){
        stageCount++;
        nowStage = stageData[stageCount];
        showNextStage();
      }else{
        showQuestion();
      }
    }else{
      endQuiz();
    }
        
  }, 2500);
}

var stageCount = 0;
var stageQuizIdx = 0;
var nowStage = stageData[0];


function createProgressSegments(segmentCount) {
  const stageProgress = document.querySelector('.stage-progress');
  stageProgress.innerHTML = ''; // 既存をクリア
  
  for (let i = 0; i < segmentCount; i++) {
    const seg = document.createElement('div');
    seg.className = 'stage-progress-segment';
    stageProgress.appendChild(seg);
  }
}

const stageOverlay = document.getElementById('stage-overlay');
const stageOverlayTitle = document.getElementById('stage-overlay-title');
const stageOverlayLoading = document.getElementById('stage-overlay-loading');
const stageText = document.getElementById('stage-title');
const stageProgress = document.getElementById('stageProgress');
  
function showNextStage(){

  document.getElementById('quiz-header').style.display = "none";
  document.getElementById('question').style.display = "none";
  document.getElementById('timer-container').style.display = "none";
  document.getElementById('buttons').style.display = "none";
  
  stageOverlayTitle.style.display = "none";
  stageOverlayLoading.style.display = "";
  
  stageOverlay.style.opacity='1';
  stageOverlay.style.display='';
  stageText.style.display='none';
  
  stageQuizIdx=0;
  
  stageText.textContent = `STAGE ` + nowStage.stage;
  
  document.getElementById('loading-msg').textContent = nowStage.loadMsg;
  
  stageProgress.style.width = "0%";
  stageOverlay.style.display = "flex";

  let progress = 0;
  stageProgress.style.transition = "none";
  stageProgress.style.width = "0%";

  const timer = setInterval(() => {
    // ランダムに進行量を変える（1/2は進行なし、1/2は0～9％）
    var upPt = Math.random() * 18 - 9;
    if(upPt < 0) upPt = 0;
    progress += upPt;
    if (progress >= 100) progress = 100;

    // 更新のたびに短いトランジションで滑らかに
    stageProgress.style.transition = "width 0.2s ease-out";
    stageProgress.style.width = progress + "%";

    // 100%に到達したら完了処理
    if (progress >= 100) {
      clearInterval(timer);

      setTimeout(() => {
        createProgressSegments(nowStage.count);
        document.getElementById('stage-info-title').textContent = `STAGE ` + nowStage.stage;
        stageOverlayTitle.style.display = "";
        stageOverlayLoading.style.display = "none";
        stageText.style.display = '';
        document.getElementById('stage-msg').textContent = nowStage.startMsg;
        stageProgress.style.width = "0%";

        //ステージ背景色の変更
        if(nowStage.stage > 1){
          //BGMスピードを変更
          bgm.playbackRate = 0.9 + 0.1 * nowStage.stage;
          bgm.volume = 1.0;
          bgm.play();

          applyColor('--color-dark', '--color-dark-' + nowStage.stage);
          applyColor('--color-light', '--color-light-' + nowStage.stage);
          //accelerateBackground(); //背景モーションを加速
          animateGradient(nowStage.stage);
        }

        setTimeout(() => {
          count = 3;
          showCountdown();
        }, 2000);
      }, 1000);
    }
  }, 100); 
}


//背景グラデーションを変更
function animateGradient(stage) {
  const duration = 1000;
  const startTop = getComputedStyle(document.documentElement).getPropertyValue('--color-bg-top').trim();
  const startBottom = getComputedStyle(document.documentElement).getPropertyValue('--color-bg-bottom').trim();
  const endTop = getComputedStyle(document.documentElement).getPropertyValue(`--color-bg-top-${stage}`).trim();
  const endBottom = getComputedStyle(document.documentElement).getPropertyValue(`--color-bg-bottom-${stage}`).trim();

  const startTime = performance.now();

  function hexToRGB(hex){
    hex = hex.replace('#','');
    return [parseInt(hex.substr(0,2),16), parseInt(hex.substr(2,2),16), parseInt(hex.substr(4,2),16)];
  }

  function rgbToHex([r,g,b]){
    return `#${r.toString(16).padStart(2,'0')}${g.toString(16).padStart(2,'0')}${b.toString(16).padStart(2,'0')}`;
  }

  function interpolateRGB(startHex, endHex, t){
    const start = hexToRGB(startHex);
    const end = hexToRGB(endHex);
    const interp = start.map((v,i) => Math.round(v + (end[i]-v)*t));
    return rgbToHex(interp);
  }

  function animate(time){
    const t = Math.min((time - startTime)/duration, 1); // 0→1
    const topColor = interpolateRGB(startTop, endTop, t);
    const bottomColor = interpolateRGB(startBottom, endBottom, t);

    document.documentElement.style.setProperty('--color-bg-top', topColor);
    document.documentElement.style.setProperty('--color-bg-bottom', bottomColor);

    if(t < 1) requestAnimationFrame(animate);
  }

  requestAnimationFrame(animate);
}

//ステージ配色の変更
function applyColor(name, varName) {
  const value = getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
  document.documentElement.style.setProperty(name, value);
}

//背景を加速（現在不採用）
function accelerateBackground() {
  const body = document.body;
  const originalDuration = 50;  // 元のduration
  const fastDuration = 25;       // 加速時のduration
  const accelTime = 700;        // 加速にかける時間(ms)
  const decelTime = 700;       // 減速にかける時間(ms)

  function animateDuration(from, to, duration) {
    const start = performance.now();
    const diff = to - from;
    function step(now) {
      let t = (now - start) / duration;
      if (t > 1) t = 1;
      const eased = t<0.5 ? 2*t*t : -1 + (4-2*t)*t; // easeInOut
      body.style.animationDuration = (from + diff*eased) + 's';
      if (t < 1) requestAnimationFrame(step);
    }
    requestAnimationFrame(step);
  }

  // 加速
  animateDuration(originalDuration, fastDuration, accelTime);
  // 減速
  setTimeout(() => animateDuration(fastDuration, originalDuration, decelTime), accelTime);
}

function init(){

  //音声無効化を解除
  const a = new Audio();
  a.play().catch(()=>{});
  
  //後からだと鳴らないので一瞬流しておく
  bgm.volume = 0.0;
  bgm.play();
  bgm.pause();

  const se_count = document.getElementById('se_count');
  se_count.volume = 0.0;
  se_count.play();
  se_count.pause();

  // stageData.count を quizData から自動生成
  const stageCounts = quizData.reduce((acc, q) => {
    acc[q.stage] = (acc[q.stage] || 0) + 1;
    return acc;
  }, {});

  stageData.forEach(s => {
    s.count = stageCounts[s.stage] || 0;
  });

  setTimeout(() => {
    document.getElementById('first-confirm').style.display = 'none';
    showNextStage();
  }, 500);
}

// --- カウントダウン処理 ---
const overlay=document.getElementById('countdown-overlay');
const countNum=document.getElementById('countNum');
const container=document.querySelector('.container');
let count=3;

function showCountdown(){
  countNum.textContent=count;
  countNum.style.opacity='1';
  countNum.style.animation='moveUp 1s ease';

  playSound('count');
  
  countNum.addEventListener('animationend',()=>{
    countNum.style.animation='none';
    countNum.style.opacity='0';
    count--;
  
    if(count>0){
      setTimeout(showCountdown,150);
    }else{
    
      stageOverlay.style.transition='opacity .5s';
      stageOverlay.style.opacity='0';
      countNum.style.opacity='0';
      
      setTimeout(()=>{
        stageOverlay.style.display='none';
      
        document.getElementById('quiz-header').style.display = "";
        document.getElementById('question').style.display = "";
        document.getElementById('timer-container').style.display = "";
        document.getElementById('buttons').style.display = "";
        
        if(nowStage.stage=='1'){
          playSound('bgm');
        }

        showQuestion();
      },500);
    }
  },{once:true});
}


function endQuiz(){
  stopTimer();
  
  // 白フェード用のdivを生成
  const fade = document.createElement('div');
  fade.style.position = 'fixed';
  fade.style.top = 0;
  fade.style.left = 0;
  fade.style.width = '100%';
  fade.style.height = '100%';
  fade.style.backgroundColor = '#fff';
  fade.style.opacity = '0';
  fade.style.transition = 'opacity 3s';
  fade.style.zIndex = 9999;
  document.body.appendChild(fade);
  
  // 100ms遅延してからフェード開始
  setTimeout(() => {
    fade.style.opacity = 1;
  }, 100);

  setTimeout(() => {
    window.location.href = 'result.html#score=' + score; // 遷移先HTMLを指定
  }, 3500);
}

// ==== 音声処理 ====
const bgm = document.getElementById('bgm');
const se_count = document.getElementById('se_count');
const soundCache = {};

function preloadSounds(list){
  list.forEach(name=>{
    const a = new Audio('bgm/' + name + '.mp3');
    a.preload = 'auto';
    soundCache[name] = a;
  });
}

function playSound(name, vol = 1.0){

  if(name == 'count'){
    se_count.pause();
    se_count.volume = vol;
    se_count.currentTime = 0;
    se_count.play();
  }else if(name == 'bgm'){
    bgm.volume = vol;
    bgm.currentTime = 0;
    bgm.play();
  }else{
    const a = soundCache[name].cloneNode();
    a.volume = vol;   // 0.0〜1.0
    a.play();
  }
}


// ==== スマホ向けボタン押下制御 ====
function initButtonTouchEvents() {
  const buttons = document.querySelectorAll('.buttons button');
  buttons.forEach(btn => {
    let isInside = false;

    btn.addEventListener('touchstart', () => {
      isInside = true;
      btn.classList.add('pressed');
    });

    btn.addEventListener('touchmove', e => {
      const touch = e.touches[0];
      const rect = btn.getBoundingClientRect();
      const inside =
        touch.clientX >= rect.left &&
        touch.clientX <= rect.right &&
        touch.clientY >= rect.top &&
        touch.clientY <= rect.bottom;
      if (inside && !isInside) {
        btn.classList.add('pressed');
        isInside = true;
      } else if (!inside && isInside) {
        btn.classList.remove('pressed');
        isInside = false;
      }
    });

    btn.addEventListener('touchend', e => {
      e.preventDefault(); // ←追加：ブラウザのclick発火を防ぐ    
      if (isInside) {
        //btn.classList.remove('pressed');
        btn.onclick();
        //handleAnswer(btn.innerHTML); // click()呼ばず、直接呼ぶ
      } else {
        btn.classList.remove('pressed');
      }
      isInside = false;
    });
  });
}

</script>
</body>
</html>